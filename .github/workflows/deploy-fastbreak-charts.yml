name: Deploy Fastbreak Charts

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'pipeline/04-fastbreak-charts/**'
      - 'server/src/Fastbreak.Daily/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: pipeline/04-fastbreak-charts

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Build Fastbreak.Daily executable
        run: |
          dotnet publish -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true -o ../../../pipeline/04-fastbreak-charts
        working-directory: server/src/Fastbreak.Daily

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Verify Fastbreak.Daily exists
        run: ls -la Fastbreak.Daily

      - run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
